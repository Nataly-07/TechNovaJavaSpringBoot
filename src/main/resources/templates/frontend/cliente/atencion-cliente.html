<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Atención al Cliente - Technova</title>

    <link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" th:href="@{/frontend/css/estilodas.css}">
    <link rel="stylesheet" th:href="@{/frontend/css/stilotech.css}">
    <link rel="stylesheet" th:href="@{/frontend/css/color-palette.css}">
</head>
<body>
  <header class="header">
    <a th:href="@{/}" class="logo">
      <img th:src="@{/frontend/imagenes/logo technova.png}" alt="Logo">
      <span>TECHNOVA</span>
    </a>

    <div class="acciones-usuario">
      <a th:href="@{/cliente/perfil}" class="account"><i class='bx bx-user-circle'></i> <span>Perfil</span></a>
      <form method="POST" th:action="@{/logout}" style="display:inline;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit" style="background:none;border:none;color:inherit;cursor:pointer;display:inline-flex;align-items:center;gap:5px;" class="account">
          <i class='bx bx-log-out'></i> <span>Cerrar Sesión</span>
        </button>
      </form>
    </div>
  </header>

  <div class="dashboard-wrapper">
    <div th:replace="~{frontend/layouts/sidebar-cliente :: sidebar}"></div>

    <main class="main-content">
      <div class="welcome-section">
        <h1><i class='bx bx-headphone'></i> Atención al Cliente</h1>
        <p>Gestiona tus tickets de soporte y consultas</p>
      </div>

      <div class="tickets-container">
        <div class="ticket-form-section">
          <h2><i class='bx bx-plus-circle'></i> Crear Nuevo Ticket</h2>
          <form id="ticketForm" class="ticket-form">
            <div class="form-group">
              <label for="tema">Tema</label>
              <input type="text" id="tema" name="tema" required placeholder="Ej: Problema con mi pedido">
            </div>
            <div class="form-group">
              <label for="descripcion">Descripción</label>
              <textarea id="descripcion" name="descripcion" required rows="5" placeholder="Describe tu consulta o problema..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">
              <i class='bx bx-send'></i> Enviar Ticket
            </button>
          </form>
        </div>

        <div class="tickets-list-section">
          <h2><i class='bx bx-list-ul'></i> Mis Tickets</h2>
          <div th:if="${tickets != null && !tickets.isEmpty()}">
            <div class="ticket-card" th:each="ticket : ${tickets}">
              <div class="ticket-header">
                <h3 th:text="${ticket.tema}">Tema</h3>
                <span th:classappend="'status-' + ${ticket.estado != null ? #strings.toLowerCase(ticket.estado) : 'pendiente'}" class="status-badge">
                  <th:block th:if="${ticket.estado == 'abierto'}">
                    <i class='bx bx-time-five'></i> Abierto
                  </th:block>
                  <th:block th:if="${ticket.estado == 'en_proceso'}">
                    <i class='bx bx-loader'></i> En Proceso
                  </th:block>
                  <th:block th:if="${ticket.estado == 'resuelto' || ticket.estado == 'cerrado'}">
                    <i class='bx bx-check-circle'></i> Resuelto
                  </th:block>
                  <th:block th:if="${ticket.estado != null && ticket.estado != 'abierto' && ticket.estado != 'en_proceso' && ticket.estado != 'resuelto' && ticket.estado != 'cerrado'}">
                    <i class='bx bx-info-circle'></i> <span th:text="${ticket.estado}">Estado</span>
                  </th:block>
                  <th:block th:if="${ticket.estado == null}">
                    <i class='bx bx-time-five'></i> Pendiente
                  </th:block>
                </span>
              </div>
              <div class="ticket-body">
                <p th:text="${ticket.descripcion}">Descripción</p>
                <div class="ticket-meta">
                  <span><i class='bx bx-calendar'></i> <span th:text="${ticket.fechaConsulta != null ? #temporals.format(ticket.fechaConsulta, 'dd/MM/yyyy HH:mm') : 'N/A'}">Fecha</span></span>
                </div>
                <th:block th:if="${ticket.respuesta != null && !ticket.respuesta.isEmpty()}">
                  <div class="respuesta-section" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                    <h4 style="color: #667eea; margin-bottom: 10px; font-size: 1rem;"><i class='bx bx-message-check'></i> Respuesta del Administrador:</h4>
                    <p style="background: #f5f5f5; padding: 10px; border-radius: 8px; color: #555; margin: 0;" th:text="${ticket.respuesta}">Respuesta</p>
                  </div>
                </th:block>
              </div>
            </div>
          </div>
          <div th:if="${tickets == null || tickets.isEmpty()}" class="empty-state">
            <i class='bx bx-inbox' style="font-size: 4rem; color: #ccc; margin-bottom: 20px;"></i>
            <h3>No tienes tickets</h3>
            <p>Crea un nuevo ticket para contactar con atención al cliente</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <footer>
    <p>&copy; 2025 Technova</p>
  </footer>

  <style>
    .tickets-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 20px;
    }

    .ticket-form-section, .tickets-list-section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .ticket-form-section h2, .tickets-list-section h2 {
      color: var(--text-primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .ticket-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .form-group label {
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-group input, .form-group textarea {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: inherit;
    }

    .ticket-card {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid var(--primary-color);
    }

    .ticket-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .ticket-header h3 {
      margin: 0;
      color: var(--text-primary);
    }

    .status-badge {
      padding: 5px 12px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-abierto {
      background: #e3f2fd;
      color: #1976d2;
    }

    .status-en_proceso {
      background: #fff3e0;
      color: #f57c00;
    }

    .status-cerrado {
      background: #e8f5e8;
      color: #388e3c;
    }

    .ticket-body p {
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    .ticket-meta {
      font-size: 0.9rem;
      color: var(--text-secondary);
      display: flex;
      gap: 15px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    @media (max-width: 768px) {
      .tickets-container {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <script th:inline="javascript">
    /*<![CDATA[*/
    const usuarioId = /*[[${usuario != null ? usuario.id : null}]]*/ null;
    
    document.getElementById('ticketForm')?.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!usuarioId) {
        alert('Debes iniciar sesión para crear un ticket');
        return;
      }
      
      const tema = document.getElementById('tema').value.trim();
      const descripcion = document.getElementById('descripcion').value.trim();
      
      if (!tema || !descripcion) {
        alert('Por favor completa todos los campos');
        return;
      }
      
      // Obtener token CSRF si está disponible
      const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || 
                       document.querySelector('input[name="_csrf"]')?.value || '';
      
      // Crear FormData para enviar los datos
      const formData = new URLSearchParams();
      formData.append('usuarioId', usuarioId);
      formData.append('tema', tema);
      formData.append('descripcion', descripcion);
      
      try {
        const headers = {
          'Content-Type': 'application/x-www-form-urlencoded'
        };
        
        // Agregar token CSRF si está disponible
        if (csrfToken) {
          formData.append('_csrf', csrfToken);
        }
        
        const response = await fetch('/api/atencion-cliente', {
          method: 'POST',
          headers: headers,
          body: formData.toString()
        });
        
        if (response.ok) {
          const result = await response.json();
          alert('Ticket creado exitosamente');
          // Limpiar el formulario
          document.getElementById('tema').value = '';
          document.getElementById('descripcion').value = '';
          // Recargar la página para mostrar el nuevo ticket
          setTimeout(() => {
            location.reload();
          }, 500);
        } else {
          const errorText = await response.text();
          console.error('Error response:', response.status, errorText);
          let errorMessage = 'Error al crear el ticket.';
          if (response.status === 401) {
            errorMessage = 'No estás autenticado. Por favor inicia sesión nuevamente.';
          } else if (response.status === 403) {
            errorMessage = 'No tienes permisos para realizar esta acción.';
          } else if (response.status === 400) {
            errorMessage = 'Datos inválidos. Por favor verifica la información ingresada.';
          }
          alert(errorMessage);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error al crear el ticket: ' + error.message);
      }
    });
    /*]]>*/
  </script>
</body>
</html>

