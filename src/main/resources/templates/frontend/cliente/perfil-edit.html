<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Editar Perfil - Technova</title>

    <link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" th:href="@{/frontend/css/estilodas.css}">
    <link rel="stylesheet" th:href="@{/frontend/css/stilotech.css}">
    <link rel="stylesheet" th:href="@{/frontend/css/color-palette.css}">
    <style>
        .edit-profile-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .edit-profile-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        .edit-profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .edit-profile-header i {
            font-size: 2rem;
            color: #667eea;
        }

        .edit-profile-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.8rem;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-group label i {
            margin-right: 8px;
            color: #667eea;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input[readonly],
        .form-group select[disabled] {
            background-color: #f5f5f5;
            cursor: not-allowed;
            color: #666;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 2px solid #f0f0f0;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .password-info {
            background: #e3f2fd;
            padding: 12px 15px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 0.85rem;
            color: #1976d2;
            border-left: 3px solid #1976d2;
        }

        .info-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .info-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.1rem;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: #666;
        }

        .info-item i {
            color: #667eea;
            font-size: 1.2rem;
        }

        .info-item:last-child {
            margin-bottom: 0;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .edit-profile-card {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
  <header class="header">
    <a th:href="@{/}" class="logo">
      <img th:src="@{'/frontend/imagenes/logo technova.png'}" alt="Logo" style="height: 52px;">
      <span>TECHNOVA</span>
    </a>

    <div class="acciones-usuario">
      <a th:href="@{/cliente/perfil}" class="account"><i class='bx bx-user-circle'></i> <span>Perfil</span></a>
      <form method="POST" th:action="@{/logout}" style="display:inline;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit" style="background:none;border:none;color:inherit;cursor:pointer;display:inline-flex;align-items:center;gap:5px;" class="account">
          <i class='bx bx-log-out'></i> <span>Cerrar Sesión</span>
        </button>
      </form>
    </div>
  </header>

  <div class="dashboard-wrapper">
    <div th:replace="~{frontend/layouts/sidebar-cliente :: sidebar}"></div>

    <main class="main-content">
      <div class="edit-profile-container">
        <div class="edit-profile-card">
          <div class="edit-profile-header">
            <i class='bx bx-edit-alt'></i>
            <h2>Editar Perfil</h2>
          </div>

          <div th:if="${mensaje}" th:classappend="${tipoMensaje == 'success' ? 'alert-success' : 'alert-error'}" class="alert">
            <i th:class="${tipoMensaje == 'success' ? 'bx bx-check-circle' : 'bx bx-error-circle'}"></i>
            <span th:text="${mensaje}"></span>
          </div>

          <!-- Información del usuario (solo lectura) -->
          <div class="info-section">
            <h3><i class='bx bx-info-circle'></i> Información Personal</h3>
            <div class="info-item">
              <i class='bx bx-user'></i>
              <span><strong>Nombre:</strong> <span th:text="${usuario != null ? usuario.name : 'N/A'}">N/A</span></span>
            </div>
            <div class="info-item" th:if="${usuario != null && usuario.firstName != null}">
              <i class='bx bx-user-circle'></i>
              <span><strong>Primer Nombre:</strong> <span th:text="${usuario.firstName}">N/A</span></span>
            </div>
            <div class="info-item" th:if="${usuario != null && usuario.lastName != null}">
              <i class='bx bx-user-circle'></i>
              <span><strong>Apellido:</strong> <span th:text="${usuario.lastName}">N/A</span></span>
            </div>
            <div class="info-item">
              <i class='bx bx-envelope'></i>
              <span><strong>Correo:</strong> <span th:text="${usuario != null ? usuario.email : 'N/A'}">N/A</span></span>
            </div>
            <div class="info-item" th:if="${usuario != null && usuario.documentType != null}">
              <i class='bx bx-id-card'></i>
              <span><strong>Documento:</strong> <span th:text="${usuario.documentType}">N/A</span> - <span th:text="${usuario.documentNumber}">N/A</span></span>
            </div>
          </div>

          <form th:action="@{/perfil/edit}" method="POST" th:object="${usuario}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" th:field="*{id}" />
            <input type="hidden" th:field="*{role}" />
            <input type="hidden" th:field="*{name}" />
            <input type="hidden" th:field="*{firstName}" />
            <input type="hidden" th:field="*{lastName}" />
            <input type="hidden" th:field="*{email}" />
            <input type="hidden" th:field="*{documentType}" />
            <input type="hidden" th:field="*{documentNumber}" />

            <div class="form-group">
              <label><i class='bx bx-phone'></i> Teléfono</label>
              <input type="tel" th:field="*{phone}" placeholder="Número de teléfono" />
            </div>

            <div class="form-group">
              <label><i class='bx bx-home'></i> Dirección</label>
              <input type="text" th:field="*{address}" placeholder="Dirección de residencia" />
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="forgotPassword" name="forgotPassword" style="width: auto; cursor: pointer;" />
                <span><i class='bx bx-help-circle'></i> ¿Olvidaste tu contraseña?</span>
              </label>
            </div>

            <!-- Sección de contraseña actual (mostrar si NO olvidó) -->
            <div id="currentPasswordSection">
              <div class="form-group">
                <label><i class='bx bx-lock-alt'></i> Contraseña Actual *</label>
                <input type="password" name="currentPassword" id="currentPassword" placeholder="Ingresa tu contraseña actual" required />
                <div class="password-info">
                  <i class='bx bx-info-circle'></i> Debes ingresar tu contraseña actual para poder realizar cambios
                </div>
              </div>
            </div>

            <!-- Sección de validación de identidad (mostrar si olvidó) -->
            <div id="forgotPasswordSection" style="display: none;">
              <div class="info-section" style="background: #fff3cd; border-left-color: #ffc107;">
                <h3><i class='bx bx-shield'></i> Verificación de Identidad</h3>
                <p style="margin: 0; color: #856404;">Por seguridad, verifica tu identidad con los siguientes datos:</p>
              </div>

              <div class="form-group">
                <label><i class='bx bx-envelope'></i> Correo Electrónico *</label>
                <input type="email" name="verifyEmail" id="verifyEmail" placeholder="Ingresa tu correo electrónico" />
                <div class="error-message d-none" id="verifyEmailError" style="color: #ef4444; font-size: 0.85rem; margin-top: 5px;"></div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label><i class='bx bx-id-card'></i> Tipo de Documento *</label>
                  <select name="verifyDocumentType" id="verifyDocumentType">
                    <option value="">Selecciona un tipo</option>
                    <option value="CC">Cédula de Ciudadanía</option>
                    <option value="CE">Cédula de Extranjería</option>
                    <option value="PA">Pasaporte</option>
                    <option value="TI">Tarjeta de Identidad</option>
                  </select>
                </div>

                <div class="form-group">
                  <label><i class='bx bx-id-card'></i> Número de Documento *</label>
                  <input type="text" name="verifyDocumentNumber" id="verifyDocumentNumber" placeholder="Número de documento" />
                  <div class="error-message d-none" id="verifyDocumentError" style="color: #ef4444; font-size: 0.85rem; margin-top: 5px;"></div>
                </div>
              </div>

              <div class="form-group">
                <label><i class='bx bx-phone'></i> Número de Teléfono *</label>
                <input type="tel" name="verifyPhone" id="verifyPhone" placeholder="Número de teléfono registrado" />
                <div class="error-message d-none" id="verifyPhoneError" style="color: #ef4444; font-size: 0.85rem; margin-top: 5px;"></div>
              </div>

              <div class="form-group">
                <button type="button" id="verifyIdentityBtn" class="btn" style="background: #ffc107; color: #000;">
                  <i class='bx bx-check-circle'></i> Verificar Identidad
                </button>
                <div id="verificationStatus" style="margin-top: 10px; display: none;"></div>
              </div>
            </div>

            <!-- Sección de nueva contraseña (habilitar después de verificación) -->
            <div id="newPasswordSection" style="display: none;">
              <div class="info-section" style="background: #d4edda; border-left-color: #28a745;">
                <h3><i class='bx bx-check-circle'></i> Identidad Verificada</h3>
                <p style="margin: 0; color: #155724;">Ahora puedes crear una nueva contraseña</p>
              </div>

              <div class="form-group">
                <label><i class='bx bx-lock-alt'></i> Nueva Contraseña *</label>
                <input type="password" name="newPassword" id="newPassword" placeholder="Mínimo 8 caracteres, mayúscula, minúscula, número y carácter especial" disabled />
                <div class="password-requisitos" id="password-requisitos" style="margin-top: 10px; font-size: 12px; color: #666; display: none;">
                  <p class="requisito" data-req="length" style="margin: 2px 0;">✗ Mínimo 8 caracteres</p>
                  <p class="requisito" data-req="upper" style="margin: 2px 0;">✗ Mayúscula</p>
                  <p class="requisito" data-req="lower" style="margin: 2px 0;">✗ Minúscula</p>
                  <p class="requisito" data-req="digit" style="margin: 2px 0;">✗ Número</p>
                  <p class="requisito" data-req="special" style="margin: 2px 0;">✗ Carácter especial</p>
                </div>
              </div>

              <div class="form-group">
                <label><i class='bx bx-lock-alt'></i> Confirmar Nueva Contraseña *</label>
                <input type="password" name="confirmPassword" id="confirmPassword" placeholder="Repite la nueva contraseña" disabled />
                <div class="error-message d-none" id="confirmPasswordError" style="color: #ef4444; font-size: 0.85rem; margin-top: 5px;"></div>
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">
                <i class='bx bx-save'></i> Guardar Cambios
              </button>
              <a th:href="@{/cliente/perfil}" class="btn btn-secondary">
                <i class='bx bx-x'></i> Cancelar
              </a>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>

  <footer>
    <p>&copy; 2025 Technova</p>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const forgotPasswordCheckbox = document.getElementById('forgotPassword');
      const currentPasswordSection = document.getElementById('currentPasswordSection');
      const forgotPasswordSection = document.getElementById('forgotPasswordSection');
      const newPasswordSection = document.getElementById('newPasswordSection');
      const verifyIdentityBtn = document.getElementById('verifyIdentityBtn');
      const newPasswordInput = document.getElementById('newPassword');
      const confirmPasswordInput = document.getElementById('confirmPassword');
      const passwordRequisitos = document.getElementById('password-requisitos');
      const requisitoElements = document.querySelectorAll('.requisito');
      const form = document.querySelector('form');
      let identityVerified = false;

      // Toggle entre contraseña actual y olvidé contraseña
      if (forgotPasswordCheckbox) {
        forgotPasswordCheckbox.addEventListener('change', function() {
          if (this.checked) {
            currentPasswordSection.style.display = 'none';
            forgotPasswordSection.style.display = 'block';
            document.getElementById('currentPassword').removeAttribute('required');
          } else {
            currentPasswordSection.style.display = 'block';
            forgotPasswordSection.style.display = 'none';
            newPasswordSection.style.display = 'none';
            document.getElementById('currentPassword').setAttribute('required', 'required');
            identityVerified = false;
            resetVerificationFields();
          }
        });
      }

      function resetVerificationFields() {
        document.getElementById('verifyEmail').value = '';
        document.getElementById('verifyDocumentType').value = '';
        document.getElementById('verifyDocumentNumber').value = '';
        document.getElementById('verifyPhone').value = '';
        if (newPasswordInput) {
          newPasswordInput.value = '';
          newPasswordInput.disabled = true;
        }
        if (confirmPasswordInput) {
          confirmPasswordInput.value = '';
          confirmPasswordInput.disabled = true;
        }
      }

      // Función para validar la contraseña (igual que en registro)
      function validarPassword(password) {
        return {
          length: password.length >= 8,
          upper: /[A-Z]/.test(password),
          lower: /[a-z]/.test(password),
          digit: /\d/.test(password),
          special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };
      }

      // Función para actualizar la visualización de requisitos
      function actualizarRequisitos(validaciones) {
        let todosCompletos = true;

        requisitoElements.forEach(element => {
          const tipo = element.getAttribute('data-req');
          const esValido = validaciones[tipo];

          if (esValido) {
            element.innerHTML = '✓ ' + element.textContent.substring(2);
            element.style.color = '#10b981';
            element.style.fontWeight = '600';
          } else {
            element.innerHTML = '✗ ' + element.textContent.substring(2);
            element.style.color = '#ef4444';
            element.style.fontWeight = '400';
            todosCompletos = false;
          }
        });

        return todosCompletos;
      }

      // Verificar identidad
      if (verifyIdentityBtn) {
        verifyIdentityBtn.addEventListener('click', async function() {
          const email = document.getElementById('verifyEmail').value.trim();
          const documentType = document.getElementById('verifyDocumentType').value;
          const documentNumber = document.getElementById('verifyDocumentNumber').value.trim();
          const phone = document.getElementById('verifyPhone').value.trim();
          const verificationStatus = document.getElementById('verificationStatus');

          // Validar campos
          if (!email || !documentType || !documentNumber || !phone) {
            verificationStatus.style.display = 'block';
            verificationStatus.innerHTML = '<div style="color: #ef4444;"><i class="bx bx-error-circle"></i> Por favor completa todos los campos</div>';
            return;
          }

          // Deshabilitar botón mientras se verifica
          this.disabled = true;
          this.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Verificando...';

          try {
            const response = await fetch('/api/usuarios/verificar-identidad', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                email: email,
                documentType: documentType,
                documentNumber: documentNumber,
                phone: phone
              })
            });

            const data = await response.json();

            if (response.ok && data.valid) {
              identityVerified = true;
              verificationStatus.style.display = 'block';
              verificationStatus.innerHTML = '<div style="color: #28a745;"><i class="bx bx-check-circle"></i> Identidad verificada correctamente</div>';
              newPasswordSection.style.display = 'block';
              newPasswordInput.disabled = false;
              confirmPasswordInput.disabled = false;
              newPasswordInput.setAttribute('required', 'required');
              confirmPasswordInput.setAttribute('required', 'required');
            } else {
              identityVerified = false;
              verificationStatus.style.display = 'block';
              verificationStatus.innerHTML = '<div style="color: #ef4444;"><i class="bx bx-error-circle"></i> ' + (data.message || 'Los datos no coinciden con nuestros registros') + '</div>';
            }
          } catch (error) {
            identityVerified = false;
            verificationStatus.style.display = 'block';
            verificationStatus.innerHTML = '<div style="color: #ef4444;"><i class="bx bx-error-circle"></i> Error al verificar. Intenta nuevamente.</div>';
          } finally {
            this.disabled = false;
            this.innerHTML = '<i class="bx bx-check-circle"></i> Verificar Identidad';
          }
        });
      }

      // Validar nueva contraseña mientras se escribe
      if (newPasswordInput) {
        newPasswordInput.addEventListener('input', function() {
          if (this.disabled) return;
          
          const password = this.value;
          
          if (password.length > 0) {
            passwordRequisitos.style.display = 'block';
            const validaciones = validarPassword(password);
            const esValida = actualizarRequisitos(validaciones);
            
            if (esValida) {
              this.style.borderColor = '#10b981';
              this.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
            } else {
              this.style.borderColor = '#e2e8f0';
              this.style.boxShadow = 'none';
            }
          } else {
            passwordRequisitos.style.display = 'none';
            this.style.borderColor = '#e2e8f0';
            this.style.boxShadow = 'none';
          }
          
          // Validar confirmación si ya hay texto
          if (confirmPasswordInput && confirmPasswordInput.value.length > 0) {
            validarConfirmacionPassword();
          }
        });
      }

      // Validar confirmación de contraseña
      function validarConfirmacionPassword() {
        if (!newPasswordInput || !confirmPasswordInput) return;
        
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        const errorDiv = document.getElementById('confirmPasswordError');

        if (confirmPassword.length === 0) {
          confirmPasswordInput.style.borderColor = '#e2e8f0';
          confirmPasswordInput.style.boxShadow = 'none';
          if (errorDiv) {
            errorDiv.style.display = 'none';
            errorDiv.classList.add('d-none');
          }
          return;
        }

        if (newPassword.length > 0 && confirmPassword.length > 0) {
          if (newPassword === confirmPassword) {
            confirmPasswordInput.style.borderColor = '#10b981';
            confirmPasswordInput.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
            if (errorDiv) {
              errorDiv.style.display = 'none';
              errorDiv.classList.add('d-none');
            }
          } else {
            confirmPasswordInput.style.borderColor = '#ef4444';
            confirmPasswordInput.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
            if (errorDiv) {
              errorDiv.textContent = 'Las contraseñas no coinciden.';
              errorDiv.style.display = 'block';
              errorDiv.classList.remove('d-none');
            }
          }
        }
      }

      if (confirmPasswordInput) {
        confirmPasswordInput.addEventListener('input', validarConfirmacionPassword);
      }

      // Validar formulario antes de enviar
      if (form) {
        form.addEventListener('submit', function(e) {
          const forgotPassword = forgotPasswordCheckbox.checked;
          const currentPassword = document.getElementById('currentPassword').value;
          const newPassword = newPasswordInput ? newPasswordInput.value : '';
          const confirmPassword = confirmPasswordInput ? confirmPasswordInput.value : '';

          if (!forgotPassword) {
            // Modo normal: requiere contraseña actual
            if (!currentPassword || currentPassword.trim() === '') {
              e.preventDefault();
              alert('Debes ingresar tu contraseña actual para realizar cambios.');
              return false;
            }
          } else {
            // Modo olvidé contraseña: requiere verificación de identidad
            if (!identityVerified) {
              e.preventDefault();
              alert('Debes verificar tu identidad antes de cambiar la contraseña.');
              return false;
            }

            if (!newPassword || newPassword.trim() === '') {
              e.preventDefault();
              alert('Debes ingresar una nueva contraseña.');
              return false;
            }
          }

          // Si se ingresó nueva contraseña, validar
          if (newPassword.length > 0) {
            const validaciones = validarPassword(newPassword);
            const esValida = Object.values(validaciones).every(v => v);

            if (!esValida) {
              e.preventDefault();
              alert('La nueva contraseña no cumple con los requisitos de seguridad.');
              return false;
            }

            if (newPassword !== confirmPassword) {
              e.preventDefault();
              alert('Las contraseñas no coinciden.');
              return false;
            }

            // Agregar la nueva contraseña al formulario
            const passwordField = document.createElement('input');
            passwordField.type = 'hidden';
            passwordField.name = 'password';
            passwordField.value = newPassword;
            form.appendChild(passwordField);
          }

          // Si es modo olvidé contraseña, agregar flag
          if (forgotPassword) {
            const forgotField = document.createElement('input');
            forgotField.type = 'hidden';
            forgotField.name = 'forgotPassword';
            forgotField.value = 'true';
            form.appendChild(forgotField);
          }
        });
      }
    });
  </script>
</body>
</html>

