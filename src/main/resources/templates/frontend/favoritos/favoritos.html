<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mis Favoritos - Technova</title>
    <link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" th:href="@{/frontend/css/color-palette.css}">
    <link rel="stylesheet" th:href="@{/frontend/css/stilotech.css}">
    <link rel="stylesheet" th:href="@{/frontend/css/estilodas.css}">
    <style>
        .welcome-section {
            text-align: center;
            padding: 40px 20px;
            margin-bottom: 30px;
        }
        
        .welcome-section h1 {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .welcome-section p {
            color: #666;
            font-size: 1.1em;
        }
        
        .favoritos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .favorito-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .favorito-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .favorito-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #00d4ff;
        }
        
        .favorito-card img {
            width: 100%;
            height: 200px;
            object-fit: contain;
            border-radius: 12px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            transition: transform 0.3s ease;
        }
        
        .favorito-card:hover img {
            transform: scale(1.05);
        }
        
        .favorito-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: 600;
            min-height: 2.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.3;
        }
        
        .favorito-card .precio {
            color: #00d4ff;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .favorito-card .precio::before {
            content: '$';
            font-size: 0.9em;
        }
        
        .favorito-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: auto;
            padding-top: 15px;
        }
        
        .btn-favorito {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }
        
        .btn-favorito:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            transform: scale(1.15) rotate(5deg);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }
        
        .btn-carrito {
            background: var(--gradient-primary);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 212, 255, 0.3);
        }
        
        .btn-carrito:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.4);
        }
        
        .empty-favoritos {
            text-align: center;
            padding: 80px 20px;
            color: #666;
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 40px auto;
            max-width: 600px;
        }
        
        .empty-favoritos h2 {
            color: #999;
            margin-bottom: 15px;
            font-size: 1.8em;
        }
        
        .empty-favoritos p {
            color: #666;
            margin-bottom: 25px;
            font-size: 1.1em;
        }
        
        .empty-favoritos a {
            display: inline-block;
            background: var(--gradient-primary);
            color: white;
            padding: 15px 30px;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }
        
        .empty-favoritos a:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
        }
        
        @media (max-width: 768px) {
            .favoritos-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
                padding: 15px;
            }
            
            .welcome-section h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
  <header class="header">
    <a th:href="@{/}" class="logo">
      <img th:src="@{/frontend/imagenes/logo technova.png}" alt="Logo">
      <span>TECHNOVA</span>
    </a>

    <div class="acciones-usuario" th:if="${usuario == null}">
      <a th:href="@{/login}" class="account"><i class='bx bx-user-circle'></i> <span>Iniciar Sesión</span></a>
      <a th:href="@{/registro}" class="account"><i class='bx bx-user-plus'></i> <span>Crear Cuenta</span></a>
    </div>
    <div class="acciones-usuario" th:if="${usuario != null}">
      <a th:href="@{/cliente/perfil}" class="account"><i class='bx bx-user-circle'></i> <span>Perfil</span></a>
      <a th:href="@{/favoritos}" class="account"><i class='bx bx-heart'></i> <span>Favoritos</span></a>
      <a th:href="@{/carrito}" class="account"><i class='bx bx-cart'></i> <span>Carrito</span></a>
      <form method="POST" th:action="@{/logout}" style="display:inline;">
        <button type="submit" style="background:none;border:none;color:inherit;cursor:pointer;display:inline-flex;align-items:center;gap:5px;" class="account">
          <i class='bx bx-log-out'></i> <span>Cerrar Sesión</span>
        </button>
      </form>
    </div>
  </header>

  <div class="dashboard-wrapper" th:if="${usuario != null}">
    <div th:replace="~{frontend/layouts/sidebar-cliente :: sidebar}"></div>
    <main class="main-content">
    <div class="welcome-section">
      <h1><i class='bx bx-heart' style="color: #ff6b9d; margin-right: 10px;"></i> Mis Favoritos</h1>
      <p>Productos que has marcado como favoritos</p>
    </div>

    <div th:if="${productos != null && !productos.isEmpty()}" class="favoritos-grid">
      <div class="favorito-card" th:each="producto : ${productos}">
        <img th:src="${producto.imagen != null && !producto.imagen.isEmpty() ? (producto.imagen.startsWith('http') ? producto.imagen : '/frontend/imagenes/' + producto.imagen) : '/frontend/imagenes/foto perfil.webp'}"
             th:alt="${producto.nombre != null ? producto.nombre : 'Producto'}"
             th:onerror="this.src='/frontend/imagenes/foto perfil.webp'">
        <h3 th:text="${producto.nombre != null ? producto.nombre : 'Producto sin nombre'}">Producto</h3>
        <div class="precio" th:if="${producto.caracteristica != null && producto.caracteristica.precioVenta != null}">
          <span th:text="${#numbers.formatDecimal(producto.caracteristica.precioVenta, 0, 0)}">0</span>
        </div>
        <div class="precio" th:if="${producto.caracteristica == null || producto.caracteristica.precioVenta == null}" style="color: #999; font-style: italic;">
          Precio no disponible
        </div>
        
        <div class="favorito-actions">
          <button class="btn-favorito favorito-btn" th:data-producto-id="${producto.id}" title="Eliminar de favoritos">
            <i class='bx bx-heart'></i>
          </button>
          <button class="btn-carrito carrito-btn" th:data-producto-id="${producto.id}" title="Agregar al carrito">
            <i class='bx bx-cart'></i>
          </button>
        </div>
      </div>
    </div>

    <div th:if="${productos == null || productos.isEmpty()}" class="empty-favoritos">
      <h2>No tienes productos favoritos aún</h2>
      <p>Explora nuestro catálogo y marca tus productos favoritos con el corazón ❤️</p>
      <a th:href="@{/}">Ver Catálogo</a>
    </div>
    </main>
  </div>

  <main class="main-content" th:if="${usuario == null}">
    <div class="empty-favoritos">
      <h2>Debes iniciar sesión para ver tus favoritos</h2>
      <p>Inicia sesión o crea una cuenta para guardar tus productos favoritos</p>
      <a th:href="@{/login}">Iniciar Sesión</a>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 Technova</p>
  </footer>

  <script th:inline="javascript">
    /*<![CDATA[*/
    const usuarioId = /*[[${usuario != null ? usuario.id : null}]]*/ null;
    
    document.addEventListener("DOMContentLoaded", () => {
        const favoritoBtns = document.querySelectorAll('.favorito-btn');
        
        favoritoBtns.forEach(btn => {
            btn.addEventListener('click', async function() {
                if (!usuarioId) {
                    window.location.href = '/login';
                    return;
                }
                const productoId = btn.getAttribute('data-producto-id');
                
                if (!productoId || productoId === '' || productoId === 'null') {
                    alert('Error: No se pudo identificar el producto');
                    return;
                }
                
                if (!confirm('¿Estás seguro de que deseas eliminar este producto de tus favoritos?')) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/favoritos/usuario/${usuarioId}/producto/${productoId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        alert('Producto eliminado de favoritos');
                        // Recargar la página para actualizar la lista
                        location.reload();
                    } else if (response.status === 404) {
                        alert('El favorito no fue encontrado');
                    } else {
                        const errorText = await response.text();
                        console.error('Error response:', errorText);
                        alert('Error al eliminar el favorito. Por favor intenta nuevamente.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al eliminar el favorito: ' + error.message);
                }
            });
        });

        const carritoBtns = document.querySelectorAll('.carrito-btn');
        carritoBtns.forEach(btn => {
            btn.addEventListener('click', async function(e) {
                e.preventDefault();
                if (!usuarioId) {
                    window.location.href = '/login';
                    return;
                }
                const productoId = btn.getAttribute('data-producto-id');
                if (productoId && productoId !== '' && productoId !== 'null') {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/carrito/agregar/' + productoId;
                    
                    const csrfToken = document.querySelector('input[name="_csrf"]');
                    if (csrfToken) {
                        const csrfInput = document.createElement('input');
                        csrfInput.type = 'hidden';
                        csrfInput.name = csrfToken.name;
                        csrfInput.value = csrfToken.value;
                        form.appendChild(csrfInput);
                    }
                    
                    document.body.appendChild(form);
                    form.submit();
                }
            });
        });
    });
    /*]]>*/
  </script>
</body>
</html>

