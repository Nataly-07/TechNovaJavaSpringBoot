<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
    <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}"/>
    <title>Mensajes - Technova</title>
    <link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" th:href="@{/frontend/css/estilodas.css}">
    <link rel="stylesheet" th:href="@{/frontend/css/stilotech.css}">
    <link rel="stylesheet" th:href="@{/frontend/css/color-palette.css}">
    <style>
        body { background: #e8f0f8; }
        .main-content { background: transparent; }
        .mensajes-container {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
        }
        .header-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 35px 40px;
            margin-bottom: 30px;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.25);
            text-align: center;
            color: white;
        }
        .header-banner h1 {
            margin: 0 0 10px 0;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-weight: 700;
            color: #000000;
            -webkit-text-stroke: 0;
            text-stroke: 0;
            text-shadow: none;
        }
        .chat-container {
            display: flex;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            height: 600px;
            overflow: hidden;
        }
        .conversaciones-list {
            width: 350px;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .conversaciones-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8f9fa;
        }
        .conversaciones-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.2rem;
        }
        .conversacion-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .conversacion-item:hover {
            background: #f8f9fa;
        }
        .conversacion-item.active {
            background: #e8f0ff;
            border-left: 4px solid #667eea;
        }
        .conversacion-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
        }
        .conversacion-info {
            flex: 1;
            min-width: 0;
        }
        .conversacion-nombre {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        .conversacion-preview {
            font-size: 0.85rem;
            color: #718096;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .conversacion-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }
        .conversacion-fecha {
            font-size: 0.75rem;
            color: #94a3b8;
        }
        .no-leido-badge {
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        .chat-header-info h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1rem;
        }
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        .message.sent {
            align-items: flex-end;
        }
        .message.received {
            align-items: flex-start;
        }
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        .message.sent .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.received .message-bubble {
            background: white;
            color: #2c3e50;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .message-time {
            font-size: 0.7rem;
            color: #94a3b8;
            margin-top: 4px;
            padding: 0 8px;
        }
        .chat-input-area {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            background: white;
        }
        .chat-input-form {
            display: flex;
            gap: 10px;
        }
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 24px;
            font-size: 0.95rem;
            outline: none;
        }
        .chat-input:focus {
            border-color: #667eea;
        }
        .btn-send {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .empty-chat {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            flex-direction: column;
        }
        .empty-chat i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        .tabs-container {
            background: white;
            border-radius: 16px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        .tabs-header {
            display: flex;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .tab-button {
            flex: 1;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            padding: 20px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .tab-button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .tab-button.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-bottom: 3px solid white;
        }
        .tab-content {
            display: none;
            padding: 0;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
  <header class="header">
    <div class="logo" style="cursor: default;">
      <img th:src="@{/frontend/imagenes/logo technova.png}" alt="Logo">
      <span>TECHNOVA</span>
    </div>
    <div class="acciones-usuario">
      <a th:href="@{/empleado/perfil}" class="account"><i class='bx bx-user-circle'></i> <span>Perfil</span></a>
      <form method="POST" th:action="@{/logout}" style="display:inline;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit" style="background:none;border:none;color:inherit;cursor:pointer;display:inline-flex;align-items:center;gap:5px;" class="account">
          <i class='bx bx-log-out'></i> <span>Cerrar Sesión</span>
        </button>
      </form>
    </div>
  </header>

  <div class="dashboard-wrapper">
    <div th:replace="~{frontend/layouts/sidebar-empleado :: sidebar}"></div>
    <main class="main-content">
      <div class="mensajes-container">
        <div class="header-banner">
          <h1><i class='bx bx-message'></i> Mensajes</h1>
          <p>Gestiona tus mensajes con el administrador</p>
        </div>

        <div class="tabs-container">
          <div class="tabs-header">
            <button class="tab-button active" onclick="mostrarTab('mensajes')">
              <i class='bx bx-message'></i> Mensajes
            </button>
            <button class="tab-button" onclick="mostrarTab('quejas')">
              <i class='bx bx-error-circle'></i> Quejas
            </button>
          </div>

          <!-- Tab Mensajes -->
          <div id="tabMensajes" class="tab-content active">
            <div class="chat-container">
              <!-- Lista de Conversaciones -->
              <div class="conversaciones-list">
                <div class="conversaciones-header">
                  <h3><i class='bx bx-message-rounded'></i> Conversaciones</h3>
                </div>
                <div th:if="${conversaciones != null && !conversaciones.isEmpty()}">
                  <div class="conversacion-item" 
                       th:each="entry : ${conversaciones}"
                       th:data-conversacion-id="${entry.key}"
                       th:classappend="${conversacionId != null && conversacionId == entry.key ? 'active' : ''}"
                       th:onclick="'abrirConversacion(' + ${entry.key} + ')'">
                    <div class="conversacion-avatar">A</div>
                    <div class="conversacion-info">
                      <div class="conversacion-nombre">Administrador</div>
                      <div class="conversacion-preview" th:text="${entry.value != null && !entry.value.isEmpty() ? entry.value[0].asunto : 'Sin mensajes'}">Último mensaje</div>
                    </div>
                    <div class="conversacion-meta">
                      <div class="conversacion-fecha" 
                           th:if="${entry.value != null && !entry.value.isEmpty() && entry.value[0].createdAt != null}"
                           th:text="${#temporals.format(entry.value[0].createdAt, 'dd/MM HH:mm')}">Fecha</div>
                      <div th:if="${entry.value != null && entry.value.stream().anyMatch(m -> !m.leido)}" class="no-leido-badge">
                        <span th:text="${entry.value.stream().filter(m -> !m.leido).count()}">1</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div th:if="${conversaciones == null || conversaciones.isEmpty()}" style="padding: 40px 20px; text-align: center; color: #94a3b8;">
                  <i class='bx bx-inbox' style="font-size: 3rem; opacity: 0.5; margin-bottom: 10px; display: block;"></i>
                  <p>No hay conversaciones</p>
                </div>
              </div>

              <!-- Área de Chat -->
              <div class="chat-area">
                <th:block th:if="${conversacionId != null && mensajesConversacion != null && !mensajesConversacion.isEmpty()}">
                  <div class="chat-header">
                    <div class="chat-header-avatar">A</div>
                    <div class="chat-header-info">
                      <h3>Administrador</h3>
                    </div>
                  </div>
                  <div class="chat-messages" id="chatMessages">
                    <div class="message" 
                         th:each="mensaje : ${mensajesConversacion}"
                         th:classappend="${mensaje.tipoRemitente == 'admin' ? 'received' : 'sent'}"
                         th:data-mensaje-id="${mensaje.id}">
                      <div class="message-bubble" th:text="${mensaje.mensaje}">Mensaje</div>
                      <div class="message-time" 
                           th:if="${mensaje.createdAt != null}"
                           th:text="${#temporals.format(mensaje.createdAt, 'dd/MM/yyyy HH:mm')}">Fecha</div>
                    </div>
                  </div>
                  <div class="chat-input-area">
                    <form class="chat-input-form" onsubmit="enviarMensaje(event)">
                      <input type="text" class="chat-input" id="mensajeInput" placeholder="Escribe un mensaje..." required>
                      <button type="submit" class="btn-send">
                        <i class='bx bx-send'></i> Enviar
                      </button>
                    </form>
                  </div>
                </th:block>
                <div th:if="${conversacionId == null || mensajesConversacion == null || mensajesConversacion.isEmpty()}" class="empty-chat">
                  <i class='bx bx-message-rounded-dots'></i>
                  <h3>Selecciona una conversación</h3>
                  <p>Elige una conversación de la lista para comenzar a chatear</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Tab Quejas -->
          <div id="tabQuejas" class="tab-content">
            <div style="padding: 60px 20px; text-align: center; color: #7f8c8d;">
              <i class='bx bx-error-circle' style="font-size: 4rem; margin-bottom: 20px; opacity: 0.5; display: block;"></i>
              <h3>Sección de Quejas</h3>
              <p>Esta sección estará disponible próximamente.</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script th:inline="javascript">
    var datosIniciales = {
      usuarioId: /*[[${usuario != null ? usuario.id : null}]]*/ null,
      conversacionId: /*[[${conversacionId != null ? conversacionId : null}]]*/ null
    };
  </script>
  <script>
    function mostrarTab(tab) {
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
      event.target.closest('.tab-button').classList.add('active');
    }

    function abrirConversacion(conversacionId) {
      window.location.href = '/empleado/mensajes?conversacionId=' + conversacionId;
    }

    function enviarMensaje(event) {
      event.preventDefault();
      var mensaje = document.getElementById('mensajeInput').value.trim();
      if (!mensaje) return;

      var csrfToken = document.querySelector('meta[name="_csrf"]') ? document.querySelector('meta[name="_csrf"]').content : '';
      var csrfHeaderName = document.querySelector('meta[name="_csrf_header"]') ? document.querySelector('meta[name="_csrf_header"]').content : '';
      
      var headers = {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      };
      
      if (csrfToken && csrfHeaderName) {
        headers[csrfHeaderName] = csrfToken;
      }

      // El remitenteId debe ser el ID del admin con quien está chateando
      // conversacionId es el ID del admin
      if (!datosIniciales.conversacionId) {
        alert('Por favor selecciona una conversación primero');
        return;
      }

      var mensajeData = {
        empleadoId: datosIniciales.usuarioId,
        remitenteId: datosIniciales.conversacionId,
        tipoRemitente: 'empleado',
        asunto: 'Mensaje',
        mensaje: mensaje,
        tipo: 'general',
        prioridad: 'normal'
      };

      fetch('/api/mensajes-empleado', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(mensajeData)
      })
      .then(response => response.ok ? response.json() : response.text().then(t => { throw new Error(t); }))
      .then(data => {
        document.getElementById('mensajeInput').value = '';
        location.reload();
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar el mensaje: ' + error.message);
      });
    }

    // Auto-scroll al final del chat
    var chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  </script>
</body>
</html>
