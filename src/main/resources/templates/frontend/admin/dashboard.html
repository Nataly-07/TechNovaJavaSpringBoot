<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Dashboard - Technova</title>

    <link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" th:href="@{/frontend/css/estilodas.css}">
    <link rel="stylesheet" th:href="@{/frontend/css/stilotech.css}">
    <link rel="stylesheet" th:href="@{/frontend/css/color-palette.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .dashboard-container {
            padding: 30px;
        }

        .dashboard-header {
            margin-bottom: 30px;
        }

        .dashboard-header h1 {
            color: #2c3e50;
            font-size: 2.2rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card.ventas::before {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card.productos::before {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stat-card.compras::before {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stat-card.usuarios::before {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .stat-card-title {
            font-size: 0.95rem;
            color: #7f8c8d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card-icon {
            font-size: 2.5rem;
            opacity: 0.2;
            color: #667eea;
        }

        .stat-card-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-card-subtitle {
            font-size: 0.85rem;
            color: #95a5a6;
        }

        .stat-card-growth {
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-card-growth.positive {
            color: #00cc44;
        }

        .stat-card-growth.negative {
            color: #ff4444;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 968px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .chart-card h3 {
            color: #2c3e50;
            margin: 0 0 20px 0;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .table-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .table-card h3 {
            color: #2c3e50;
            margin: 0 0 20px 0;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
        }

        .products-table thead {
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        .products-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .products-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .products-table tbody tr:hover {
            background: #f8f9fa;
        }

        .product-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
  <header class="header">
    <div class="logo" style="cursor: default;">
      <img th:src="@{/frontend/imagenes/logo technova.png}" alt="Logo">
      <span>TECHNOVA</span>
    </div>

    <div class="acciones-usuario">
      <a th:href="@{/admin/perfil}" class="account"><i class='bx bx-user-circle'></i> <span>Perfil</span></a>
      <form method="POST" th:action="@{/logout}" style="display:inline;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit" style="background:none;border:none;color:inherit;cursor:pointer;display:inline-flex;align-items:center;gap:5px;" class="account">
          <i class='bx bx-log-out'></i> <span>Cerrar Sesión</span>
        </button>
      </form>
    </div>
  </header>

  <div class="dashboard-wrapper">
    <div th:replace="~{frontend/layouts/sidebar-admin :: sidebar}"></div>

    <main class="main-content">
      <div class="dashboard-container">
        <div class="dashboard-header">
          <h1><i class='bx bx-chart'></i> Dashboard Administrativo</h1>
        </div>

        <!-- Tarjetas de Estadísticas -->
        <div class="stats-grid" th:if="${dashboard != null}">
          <!-- Ventas -->
          <div class="stat-card ventas">
            <div class="stat-card-header">
              <div>
                <div class="stat-card-title">Total Ventas</div>
                <div class="stat-card-value" th:text="${dashboard.totalIngresos != null ? '$' + #numbers.formatDecimal(dashboard.totalIngresos, 0, 'POINT', 2, 'POINT') : '$0.00'}">$0.00</div>
                <div class="stat-card-subtitle" th:text="${dashboard.totalVentas != null ? dashboard.totalVentas + ' ventas realizadas' : '0 ventas'}">0 ventas</div>
              </div>
              <i class='bx bx-trending-up stat-card-icon'></i>
            </div>
            <div class="stat-card-growth" 
                 th:if="${dashboard != null and dashboard.crecimientoVentas != null and dashboard.crecimientoVentas.doubleValue() != 0}"
                 th:classappend="${dashboard.crecimientoVentas.doubleValue() > 0 ? 'positive' : 'negative'}">
              <i th:class="${dashboard.crecimientoVentas.doubleValue() > 0 ? 'bx bx-up-arrow-alt' : 'bx bx-down-arrow-alt'}"></i>
              <span th:text="${#numbers.formatDecimal(dashboard.crecimientoVentas, 0, 'POINT', 2, 'POINT') + '%'}">0%</span>
              vs mes anterior
            </div>
          </div>

          <!-- Ventas Este Mes -->
          <div class="stat-card ventas">
            <div class="stat-card-header">
              <div>
                <div class="stat-card-title">Ventas Este Mes</div>
                <div class="stat-card-value" th:text="${dashboard.ingresosEsteMes != null ? '$' + #numbers.formatDecimal(dashboard.ingresosEsteMes, 0, 'POINT', 2, 'POINT') : '$0.00'}">$0.00</div>
                <div class="stat-card-subtitle" th:text="${dashboard.ventasEsteMes != null ? dashboard.ventasEsteMes + ' pedidos este mes' : '0 pedidos'}">0 pedidos</div>
              </div>
              <i class='bx bx-calendar stat-card-icon'></i>
            </div>
          </div>

          <!-- Productos -->
          <div class="stat-card productos">
            <div class="stat-card-header">
              <div>
                <div class="stat-card-title">Productos</div>
                <div class="stat-card-value" th:text="${dashboard.productosActivos != null ? dashboard.productosActivos : 0}">0</div>
                <div class="stat-card-subtitle" th:text="${dashboard.productosStockBajo != null ? dashboard.productosStockBajo + ' con stock bajo' : '0 con stock bajo'}">0 con stock bajo</div>
              </div>
              <i class='bx bx-package stat-card-icon'></i>
            </div>
          </div>

          <!-- Compras -->
          <div class="stat-card compras">
            <div class="stat-card-header">
              <div>
                <div class="stat-card-title">Compras a Proveedores</div>
                <div class="stat-card-value" th:text="${dashboard.totalGastado != null ? '$' + #numbers.formatDecimal(dashboard.totalGastado, 0, 'POINT', 2, 'POINT') : '$0.00'}">$0.00</div>
                <div class="stat-card-subtitle" th:text="${dashboard.totalCompras != null ? dashboard.totalCompras + ' compras realizadas' : '0 compras'}">0 compras</div>
              </div>
              <i class='bx bx-shopping-bag stat-card-icon'></i>
            </div>
          </div>

          <!-- Usuarios -->
          <div class="stat-card usuarios">
            <div class="stat-card-header">
              <div>
                <div class="stat-card-title">Usuarios</div>
                <div class="stat-card-value" th:text="${dashboard.totalClientes != null ? dashboard.totalClientes : 0}">0</div>
                <div class="stat-card-subtitle" th:text="${dashboard.totalEmpleados != null ? dashboard.totalEmpleados + ' empleados activos' : '0 empleados'}">0 empleados</div>
              </div>
              <i class='bx bx-user stat-card-icon'></i>
            </div>
          </div>

          <!-- Promedio Venta -->
          <div class="stat-card ventas">
            <div class="stat-card-header">
              <div>
                <div class="stat-card-title">Promedio por Venta</div>
                <div class="stat-card-value" th:text="${dashboard.promedioVenta != null ? '$' + #numbers.formatDecimal(dashboard.promedioVenta, 0, 'POINT', 2, 'POINT') : '$0.00'}">$0.00</div>
                <div class="stat-card-subtitle">Promedio de ticket</div>
              </div>
              <i class='bx bx-dollar stat-card-icon'></i>
            </div>
          </div>
        </div>

        <!-- Gráficos -->
        <div class="charts-grid" th:if="${dashboard != null && dashboard.ventasPorMes != null}">
          <!-- Gráfico de Ventas por Mes -->
          <div class="chart-card">
            <h3><i class='bx bx-line-chart'></i> Ventas por Mes (Últimos 6 Meses)</h3>
            <div class="chart-container">
              <canvas id="ventasPorMesChart"></canvas>
            </div>
          </div>

          <!-- Información adicional -->
          <div class="chart-card">
            <h3><i class='bx bx-info-circle'></i> Resumen</h3>
            <div style="padding: 10px 0;">
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                <span style="color: #7f8c8d;">Total Pedidos:</span>
                <strong style="color: #2c3e50;" th:text="${dashboard.totalPedidos != null ? dashboard.totalPedidos : 0}">0</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                <span style="color: #7f8c8d;">Gastos Este Mes:</span>
                <strong style="color: #ff4444;" th:text="${dashboard.gastosEsteMes != null ? '$' + #numbers.formatDecimal(dashboard.gastosEsteMes, 0, 'POINT', 2, 'POINT') : '$0.00'}">$0.00</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                <span style="color: #7f8c8d;">Pedidos Pendientes:</span>
                <strong style="color: #ff9500;" th:text="${dashboard.pedidosPendientes != null ? dashboard.pedidosPendientes : 0}">0</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span style="color: #7f8c8d;">Total Productos:</span>
                <strong style="color: #2c3e50;" th:text="${dashboard.totalProductos != null ? dashboard.totalProductos : 0}">0</strong>
              </div>
            </div>
          </div>
        </div>

        <!-- Productos Más Vendidos -->
        <div class="table-card" th:if="${dashboard != null && dashboard.productosMasVendidos != null}">
          <h3><i class='bx bx-star'></i> Productos Más Vendidos</h3>
          <div th:if="${dashboard.productosMasVendidos != null && !dashboard.productosMasVendidos.isEmpty()}">
            <table class="products-table">
              <thead>
                <tr>
                  <th>Posición</th>
                  <th>Producto</th>
                  <th>Cantidad Vendida</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="producto, iterStat : ${dashboard.productosMasVendidos}">
                  <td>
                    <span class="badge badge-success" th:text="${iterStat.index + 1}">1</span>
                  </td>
                  <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                      <img th:if="${producto.imagen != null && !#strings.isEmpty(producto.imagen)}"
                           th:src="${producto.imagen != null and !#strings.isEmpty(producto.imagen) and #strings.startsWith(producto.imagen, 'http') 
                                     ? producto.imagen 
                                     : '/frontend/imagenes/' + producto.imagen}" 
                           alt="Producto" 
                           class="product-img"
                           onerror="this.src='/frontend/imagenes/placeholder.png'">
                      <img th:if="${producto.imagen == null || #strings.isEmpty(producto.imagen)}" 
                           th:src="@{/frontend/imagenes/placeholder.png}" 
                           alt="Producto" 
                           class="product-img">
                      <span th:text="${producto.nombreProducto != null ? producto.nombreProducto : 'Producto'}">Producto</span>
                    </div>
                  </td>
                  <td>
                    <strong th:text="${producto.cantidadVendida != null ? producto.cantidadVendida + ' unidades' : '0 unidades'}">0 unidades</strong>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="empty-state" th:if="${dashboard.productosMasVendidos == null || dashboard.productosMasVendidos.isEmpty()}">
            <i class='bx bx-package'></i>
            <h3>No hay productos vendidos aún</h3>
            <p>Los productos más vendidos aparecerán aquí cuando haya ventas registradas.</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <footer>
    <p>&copy; 2024 Technova. Todos los derechos reservados.</p>
  </footer>

  <script th:inline="javascript">
    /*<![CDATA[*/
    // Datos para el gráfico de ventas por mes
    var ventasPorMes = /*[[${dashboard != null ? dashboard.ventasPorMes : null}]]*/ null;
    
    if (ventasPorMes && Array.isArray(ventasPorMes) && ventasPorMes.length > 0) {
      try {
        var meses = ventasPorMes.map(function(item) {
          if (item && item.mes && item.anio) {
            return item.mes.substring(0, 3) + ' ' + item.anio;
          }
          return '';
        }).filter(function(m) { return m !== ''; });
        
        var totales = ventasPorMes.map(function(item) {
          return (item && item.total) ? parseFloat(item.total) : 0;
        });
        
        var chartCtxDashboard = document.getElementById('ventasPorMesChart');
        if (chartCtxDashboard && meses.length > 0) {
          new Chart(chartCtxDashboard, {
            type: 'line',
            data: {
              labels: meses,
              datasets: [{
                label: 'Ventas ($)',
                data: totales,
                borderColor: 'rgb(102, 126, 234)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 7
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: 'top'
                },
                tooltip: {
                  mode: 'index',
                  intersect: false,
                  callbacks: {
                    label: function(context) {
                      return 'Ventas: $' + parseFloat(context.parsed.y).toFixed(2);
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return '$' + parseFloat(value).toFixed(0);
                    }
                  }
                }
              }
            }
          });
        }
      } catch (error) {
        console.error('Error al crear gráfico:', error);
      }
    }
    /*]]>*/
  </script>

  <script th:src="@{/frontend/js/app.js}"></script>
</body>
</html>

