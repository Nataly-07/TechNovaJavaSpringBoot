<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
    <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}"/>
    <title>Mensajes - Technova</title>
    <link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" th:href="@{/frontend/css/estilodas.css}">
    <link rel="stylesheet" th:href="@{/frontend/css/stilotech.css}">
    <link rel="stylesheet" th:href="@{/frontend/css/color-palette.css}">
    <style>
        body { background: #e8f0f8; }
        .main-content { background: transparent; }
        .mensajes-container {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
        }
        .header-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 35px 40px;
            margin-bottom: 30px;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.25);
            text-align: center;
            color: white;
        }
        .header-banner h1 {
            margin: 0 0 10px 0;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-weight: 700;
            color: white;
        }
        .chat-container {
            display: flex;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            height: 600px;
            overflow: hidden;
        }
        .conversaciones-list {
            width: 350px;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .conversaciones-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .conversaciones-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.2rem;
        }
        .btn-nuevo-mensaje {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }
        .btn-nuevo-mensaje:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .conversacion-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .conversacion-item:hover {
            background: #f8f9fa;
        }
        .conversacion-item.active {
            background: #e8f0ff;
            border-left: 4px solid #667eea;
        }
        .conversacion-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
        }
        .conversacion-info {
            flex: 1;
            min-width: 0;
        }
        .conversacion-nombre {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        .conversacion-preview {
            font-size: 0.85rem;
            color: #718096;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .conversacion-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }
        .conversacion-fecha {
            font-size: 0.75rem;
            color: #94a3b8;
        }
        .no-leido-badge {
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        .chat-header-info h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1rem;
        }
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column-reverse;
        }
        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        .message.sent {
            align-items: flex-end;
        }
        .message.received {
            align-items: flex-start;
        }
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        .message.sent .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.received .message-bubble {
            background: white;
            color: #2c3e50;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .message-time {
            font-size: 0.7rem;
            color: #94a3b8;
            margin-top: 4px;
            padding: 0 8px;
        }
        .chat-input-area {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            background: white;
        }
        .chat-input-form {
            display: flex;
            gap: 10px;
        }
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 24px;
            font-size: 0.95rem;
            outline: none;
        }
        .chat-input:focus {
            border-color: #667eea;
        }
        .btn-send {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .empty-chat {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            flex-direction: column;
        }
        .empty-chat i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        .tabs-container {
            background: white;
            border-radius: 16px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        .tabs-header {
            display: flex;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .tab-button {
            flex: 1;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            padding: 20px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .tab-button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .tab-button.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-bottom: 3px solid white;
        }
        .tab-content {
            display: none;
            padding: 0;
        }
        .tab-content.active {
            display: block;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h3 {
            margin: 0;
            color: #2c3e50;
        }
        .modal-body {
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .btn-modal {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-secondary {
            background: #e2e8f0;
            color: #2c3e50;
        }
        .queja-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .reclamo-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .queja-status.status-pendiente {
            background: #ffc107;
            color: #856404;
        }
        .queja-status.status-enviado_al_admin {
            background: #17a2b8;
            color: white;
        }
        .queja-status.status-resuelto {
            background: #28a745;
            color: white;
        }
        .reclamo-prioridad {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .queja-prioridad.priority-alta {
            background: #dc3545;
            color: white;
        }
        .queja-prioridad.priority-normal {
            background: #6c757d;
            color: white;
        }
        .queja-prioridad.priority-baja {
            background: #17a2b8;
            color: white;
        }
        .reclamo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .queja-modal.active {
            display: flex;
        }
        .reclamo-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .reclamo-modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px 16px 0 0;
        }
        .queja-modal-header h3 {
            margin: 0;
            color: white;
        }
        .reclamo-modal-body {
            padding: 25px 30px;
        }
        .reclamo-detalle-item {
            margin-bottom: 20px;
        }
        .queja-detalle-item label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        .queja-detalle-item .value {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            color: #2c3e50;
        }
    </style>
</head>
<body>
  <header class="header">
    <div class="logo" style="cursor: default;">
      <img th:src="@{/frontend/imagenes/logo technova.png}" alt="Logo">
      <span>TECHNOVA</span>
    </div>

    <div class="acciones-usuario">
      <a th:href="@{/admin/perfil}" class="account"><i class='bx bx-user-circle'></i> <span>Perfil</span></a>
      <form method="POST" th:action="@{/logout}" style="display:inline;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit" style="background:none;border:none;color:inherit;cursor:pointer;display:inline-flex;align-items:center;gap:5px;" class="account">
          <i class='bx bx-log-out'></i> <span>Cerrar Sesión</span>
        </button>
      </form>
    </div>
  </header>

  <div class="dashboard-wrapper">
    <div th:replace="~{frontend/layouts/sidebar-admin :: sidebar}"></div>

    <main class="main-content">
      <div class="mensajes-container">
        <div class="header-banner">
          <h1><i class='bx bx-message'></i> Mensajes</h1>
          <p>Gestiona los mensajes con los empleados</p>
        </div>

        <div class="tabs-container">
          <div class="tabs-header">
            <button class="tab-button active" data-tab="mensajes">
              <i class='bx bx-message'></i> Mensajes
            </button>
            <button class="tab-button" data-tab="reclamos">
              <i class='bx bx-error-circle'></i> Reclamos
            </button>
          </div>

          <!-- Tab Mensajes -->
          <div id="tabMensajes" class="tab-content active">
            <div class="chat-container">
              <!-- Lista de Conversaciones -->
              <div class="conversaciones-list">
                <div class="conversaciones-header">
                  <h3><i class='bx bx-message-rounded'></i> Conversaciones</h3>
                  <button class="btn-nuevo-mensaje" id="btnNuevoMensaje">
                    <i class='bx bx-plus'></i> Nuevo
                  </button>
                </div>
                <div th:if="${conversaciones != null && !conversaciones.isEmpty()}">
                  <div class="conversacion-item" 
                       th:each="entry : ${conversaciones}"
                       th:data-conversacion-id="${entry.key}"
                       th:data-conversacion-key="${entry.key}"
                       th:classappend="${conversacionId != null && conversacionId == entry.key ? 'active' : ''}"
                       style="cursor: pointer;">
                    <div class="conversacion-avatar" th:text="${nombresEmpleados != null && nombresEmpleados.containsKey(entry.key) && nombresEmpleados.get(entry.key) != null && nombresEmpleados.get(entry.key).length() > 0 ? nombresEmpleados.get(entry.key).substring(0, 1).toUpperCase() : 'E'}">E</div>
                    <div class="conversacion-info">
                      <div class="conversacion-nombre" th:text="${nombresEmpleados != null && nombresEmpleados.containsKey(entry.key) ? nombresEmpleados.get(entry.key) : 'Empleado #' + entry.key}">Empleado</div>
                      <div class="conversacion-preview" th:text="${entry.value != null && !entry.value.isEmpty() && entry.value[0] != null && entry.value[0].asunto != null ? entry.value[0].asunto : 'Sin mensajes'}">Último mensaje</div>
                    </div>
                    <div class="conversacion-meta">
                      <div class="conversacion-fecha" 
                           th:if="${entry.value != null && !entry.value.isEmpty() && entry.value[0] != null && entry.value[0].createdAt != null}">
                        <span th:text="${#temporals.format(entry.value[0].createdAt, 'dd/MM HH:mm')}">Fecha</span>
                      </div>
                      <div th:if="${noLeidosPorConversacion != null && noLeidosPorConversacion.containsKey(entry.key) && noLeidosPorConversacion.get(entry.key) > 0}" class="no-leido-badge">
                        <span th:text="${noLeidosPorConversacion.get(entry.key)}">0</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div th:if="${conversaciones == null || conversaciones.isEmpty()}" style="padding: 40px 20px; text-align: center; color: #94a3b8;">
                  <i class='bx bx-inbox' style="font-size: 3rem; opacity: 0.5; margin-bottom: 10px; display: block;"></i>
                  <p>No hay conversaciones</p>
                </div>
              </div>

              <!-- Área de Chat -->
              <div class="chat-area">
                <th:block th:if="${conversacionId != null && mensajesConversacion != null && !mensajesConversacion.isEmpty()}">
                  <div class="chat-header">
                    <div class="chat-header-avatar" th:text="${empleadoConversacion != null && empleadoConversacion.name != null && empleadoConversacion.name.length() > 0 ? empleadoConversacion.name.substring(0, 1).toUpperCase() : 'E'}">E</div>
                    <div class="chat-header-info">
                      <h3 th:text="${empleadoConversacion != null && empleadoConversacion.name != null ? empleadoConversacion.name : 'Empleado #' + conversacionId}">Empleado</h3>
                    </div>
                  </div>
                  <div class="chat-messages" id="chatMessages">
                    <div class="message" 
                         th:each="mensaje : ${mensajesConversacion}"
                         th:classappend="${mensaje.tipoRemitente == 'admin' ? 'sent' : 'received'}"
                         th:data-mensaje-id="${mensaje.id}">
                      <div class="message-bubble" th:text="${mensaje.mensaje}">Mensaje</div>
                      <div class="message-time" 
                           th:if="${mensaje.createdAt != null}"
                           th:text="${#temporals.format(mensaje.createdAt, 'dd/MM/yyyy HH:mm')}">Fecha</div>
                    </div>
                  </div>
                  <div class="chat-input-area">
                    <form class="chat-input-form" onsubmit="enviarMensaje(event)">
                      <input type="text" class="chat-input" id="mensajeInput" placeholder="Escribe un mensaje..." required>
                      <button type="submit" class="btn-send">
                        <i class='bx bx-send'></i> Enviar
                      </button>
                    </form>
                  </div>
                </th:block>
                <div th:if="${conversacionId == null || mensajesConversacion == null || mensajesConversacion.isEmpty()}" class="empty-chat">
                  <i class='bx bx-message-rounded-dots'></i>
                  <h3>Selecciona una conversación</h3>
                  <p>Elige una conversación de la lista o crea un nuevo mensaje</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Tab Reclamos -->
          <div id="tabReclamos" class="tab-content">
            <div style="padding: 20px;">
              <h2 style="margin: 0 0 20px 0; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                <i class='bx bx-error-circle'></i> Reclamos Enviados por Empleados
              </h2>
              
              <div th:if="${reclamosEmpleados != null && !reclamosEmpleados.isEmpty()}" style="display: grid; gap: 15px;">
                <div class="reclamo-card" 
                     th:each="reclamo : ${reclamosEmpleados}"
                     th:data-reclamo-id="${reclamo != null ? reclamo.id : null}"
                     th:attr="data-reclamo-id-value=${reclamo != null ? reclamo.id : null}"
                     style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s ease;">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                    <div style="flex: 1;">
                      <h3 style="margin: 0 0 8px 0; color: #2c3e50; font-size: 1.1rem;" th:text="${reclamo.titulo != null ? reclamo.titulo : 'Sin título'}">Título</h3>
                      <p style="margin: 0; color: #718096; font-size: 0.9rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;" 
                         th:text="${reclamo.descripcion != null ? reclamo.descripcion : 'Sin descripción'}">Descripción</p>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                      <span th:classappend="'reclamo-status status-' + (${reclamo.estado != null ? #strings.toLowerCase(reclamo.estado) : 'pendiente'})"
                            class="reclamo-status"
                            th:text="${reclamo.estado != null ? #strings.capitalize(reclamo.estado) : 'Pendiente'}">Estado</span>
                      <span th:classappend="'reclamo-prioridad priority-' + (${reclamo.prioridad != null ? #strings.toLowerCase(reclamo.prioridad) : 'normal'})"
                            class="reclamo-prioridad"
                            th:text="${reclamo.prioridad != null ? #strings.capitalize(reclamo.prioridad) : 'Normal'}">Prioridad</span>
                    </div>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
                    <div style="display: flex; align-items: center; gap: 8px; color: #94a3b8; font-size: 0.85rem;">
                      <i class='bx bx-calendar'></i>
                      <span th:if="${reclamo != null && reclamo.fechaReclamo != null}">
                        <span th:text="${#temporals.format(reclamo.fechaReclamo, 'dd/MM/yyyy HH:mm')}">Fecha</span>
                      </span>
                    </div>
                    <div th:if="${reclamo.evaluacionCliente != null && !#strings.isEmpty(reclamo.evaluacionCliente)}" 
                         style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem;">
                      <i th:class="'bx ' + (${reclamo.evaluacionCliente == 'resuelta'} ? 'bx-check-circle' : 'bx-x-circle')"
                         th:style="'color: ' + (${reclamo.evaluacionCliente == 'resuelta'} ? '#28a745' : '#dc3545')"></i>
                      <span th:text="${reclamo.evaluacionCliente == 'resuelta'} ? 'Cliente indica que fue resuelto' : 'Cliente indica que no fue resuelto'"
                            th:style="'color: ' + (${reclamo.evaluacionCliente == 'resuelta'} ? '#28a745' : '#dc3545')">Evaluación</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div th:if="${reclamosEmpleados == null || reclamosEmpleados.isEmpty()}" 
                   style="padding: 60px 20px; text-align: center; color: #7f8c8d; background: white; border-radius: 12px;">
                <i class='bx bx-inbox' style="font-size: 4rem; margin-bottom: 20px; opacity: 0.5; display: block;"></i>
                <h3>No hay reclamos</h3>
                <p>No hay reclamos enviados por empleados en este momento.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal Nuevo Mensaje -->
  <div id="modalNuevoMensaje" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class='bx bx-message-add'></i> Nuevo Mensaje</h3>
        <button onclick="cerrarModalNuevoMensaje()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #94a3b8;">
          <i class='bx bx-x'></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="formNuevoMensaje" onsubmit="crearNuevoMensaje(event)">
          <div class="form-group">
            <label for="empleadoSelect">Seleccionar Empleado</label>
            <select id="empleadoSelect" required>
              <option value="">-- Selecciona un empleado --</option>
              <option th:each="empleado : ${empleados}" 
                      th:value="${empleado.id}" 
                      th:text="${empleado.name != null ? empleado.name : 'Empleado #' + empleado.id}">Empleado</option>
            </select>
          </div>
          <div class="form-group">
            <label for="asuntoInput">Asunto</label>
            <input type="text" id="asuntoInput" placeholder="Asunto del mensaje" required>
          </div>
          <div class="form-group">
            <label for="mensajeTextarea">Mensaje</label>
            <textarea id="mensajeTextarea" rows="4" placeholder="Escribe tu mensaje aquí..." required></textarea>
          </div>
          <div class="form-group">
            <label for="prioridadSelect">Prioridad</label>
            <select id="prioridadSelect" required>
              <option value="normal">Normal</option>
              <option value="alta">Alta</option>
              <option value="urgente">Urgente</option>
            </select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn-modal btn-secondary" onclick="cerrarModalNuevoMensaje()">Cancelar</button>
            <button type="submit" class="btn-modal btn-primary">Enviar Mensaje</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Detalle Reclamo -->
  <div id="modalReclamo" class="reclamo-modal">
    <div class="reclamo-modal-content">
      <div class="reclamo-modal-header">
        <h3><i class='bx bx-error-circle'></i> Detalle de Reclamo</h3>
        <button onclick="cerrarModalReclamo()" style="background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
          <i class='bx bx-x'></i>
        </button>
      </div>
      <div class="reclamo-modal-body" id="reclamoModalBody">
        <!-- Contenido dinámico -->
      </div>
    </div>
  </div>

  <script th:inline="javascript">
    var datosIniciales = {
      usuarioId: /*[[${usuario != null ? usuario.id : null}]]*/ null,
      conversacionId: /*[[${conversacionId != null ? conversacionId : null}]]*/ null
    };
  </script>
  <script>
    function mostrarTab(tab, eventElement) {
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Mapear 'reclamos' a 'Reclamos' para el ID del tab
      var tabIdMap = {
        'mensajes': 'Mensajes',
        'reclamos': 'Reclamos',
        'quejas': 'Reclamos' // Mantener compatibilidad con el nombre anterior
      };
      var tabId = 'tab' + (tabIdMap[tab] || tab.charAt(0).toUpperCase() + tab.slice(1));
      var tabElement = document.getElementById(tabId);
      if (tabElement) {
        tabElement.classList.add('active');
      }
      
      if (eventElement) {
        eventElement.classList.add('active');
      }
    }

    function abrirConversacion(conversacionId) {
      window.location.href = '/admin/mensajes?conversacionId=' + conversacionId;
    }

    function abrirModalNuevoMensaje() {
      document.getElementById('modalNuevoMensaje').classList.add('active');
    }

    function cerrarModalNuevoMensaje() {
      document.getElementById('modalNuevoMensaje').classList.remove('active');
      document.getElementById('formNuevoMensaje').reset();
    }

    function crearNuevoMensaje(event) {
      event.preventDefault();
      var empleadoId = document.getElementById('empleadoSelect').value;
      var asunto = document.getElementById('asuntoInput').value.trim();
      var mensaje = document.getElementById('mensajeTextarea').value.trim();
      var prioridad = document.getElementById('prioridadSelect').value;

      if (!empleadoId || !asunto || !mensaje) {
        alert('Por favor completa todos los campos');
        return;
      }

      var csrfToken = document.querySelector('meta[name="_csrf"]') ? document.querySelector('meta[name="_csrf"]').content : '';
      var csrfHeaderName = document.querySelector('meta[name="_csrf_header"]') ? document.querySelector('meta[name="_csrf_header"]').content : '';
      
      var headers = {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      };
      
      if (csrfToken && csrfHeaderName) {
        headers[csrfHeaderName] = csrfToken;
      }

      var mensajeData = {
        empleadoId: parseInt(empleadoId),
        remitenteId: datosIniciales.usuarioId,
        tipoRemitente: 'admin',
        asunto: asunto,
        mensaje: mensaje,
        tipo: 'general',
        prioridad: prioridad
      };

      fetch('/api/mensajes-empleado', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(mensajeData)
      })
      .then(response => response.ok ? response.json() : response.text().then(t => { throw new Error(t); }))
      .then(data => {
        cerrarModalNuevoMensaje();
        window.location.href = '/admin/mensajes?conversacionId=' + empleadoId;
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar el mensaje: ' + error.message);
      });
    }

    function enviarMensaje(event) {
      event.preventDefault();
      var mensaje = document.getElementById('mensajeInput').value.trim();
      if (!mensaje) return;

      var csrfToken = document.querySelector('meta[name="_csrf"]') ? document.querySelector('meta[name="_csrf"]').content : '';
      var csrfHeaderName = document.querySelector('meta[name="_csrf_header"]') ? document.querySelector('meta[name="_csrf_header"]').content : '';
      
      var headers = {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      };
      
      if (csrfToken && csrfHeaderName) {
        headers[csrfHeaderName] = csrfToken;
      }

      if (!datosIniciales.conversacionId) {
        alert('Por favor selecciona una conversación primero');
        return;
      }

      var mensajeData = {
        empleadoId: datosIniciales.conversacionId,
        remitenteId: datosIniciales.usuarioId,
        tipoRemitente: 'admin',
        asunto: 'Mensaje',
        mensaje: mensaje,
        tipo: 'general',
        prioridad: 'normal'
      };

      fetch('/api/mensajes-empleado', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(mensajeData)
      })
      .then(response => response.ok ? response.json() : response.text().then(t => { throw new Error(t); }))
      .then(data => {
        document.getElementById('mensajeInput').value = '';
        location.reload();
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar el mensaje: ' + error.message);
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      var chatMessages = document.getElementById('chatMessages');
      if (chatMessages) {
        chatMessages.scrollTop = 0;
      }

      var modalNuevoMensaje = document.getElementById('modalNuevoMensaje');
      if (modalNuevoMensaje) {
        modalNuevoMensaje.addEventListener('click', function(e) {
          if (e.target === this) {
            cerrarModalNuevoMensaje();
          }
        });
      }

      var modalReclamo = document.getElementById('modalReclamo');
      if (modalReclamo) {
        modalReclamo.addEventListener('click', function(e) {
          if (e.target === this) {
            cerrarModalReclamo();
          }
        });
      }

      // Configurar event listeners para las conversaciones
      var conversacionItems = document.querySelectorAll('.conversacion-item[data-conversacion-key]');
      conversacionItems.forEach(function(item) {
        item.addEventListener('click', function() {
          var conversacionId = this.getAttribute('data-conversacion-key');
          if (conversacionId) {
            abrirConversacion(conversacionId);
          }
        });
      });

      // Configurar event listeners para los tabs
      var tabButtons = document.querySelectorAll('.tab-button[data-tab]');
      tabButtons.forEach(function(button) {
        button.addEventListener('click', function() {
          var tab = this.getAttribute('data-tab');
          mostrarTab(tab, this);
        });
      });
      
      // Configurar event listener para el botón nuevo mensaje
      var btnNuevoMensaje = document.getElementById('btnNuevoMensaje');
      if (btnNuevoMensaje) {
        btnNuevoMensaje.addEventListener('click', function() {
          abrirModalNuevoMensaje();
        });
      }

      // Configurar event listeners para las tarjetas de reclamos
      var reclamoCards = document.querySelectorAll('.reclamo-card[data-reclamo-id-value]');
      reclamoCards.forEach(function(card) {
        card.addEventListener('click', function() {
          var reclamoId = this.getAttribute('data-reclamo-id-value');
          if (reclamoId) {
            mostrarDetalleReclamo(parseInt(reclamoId));
          }
        });
      });
    });

    function mostrarDetalleReclamo(reclamoId) {
      if (!reclamoId) {
        alert('Error: No se pudo obtener el ID del reclamo');
        return;
      }

      fetch('/api/reclamos/' + reclamoId)
        .then(response => {
          if (!response.ok) {
            throw new Error('Error al cargar el reclamo: ' + response.status);
          }
          return response.json();
        })
        .then(reclamo => {
          var html = '<div class="reclamo-detalle-item">' +
                    '<label><i class="bx bx-text"></i> Título</label>' +
                    '<div class="value">' + (reclamo.titulo || 'Sin título') + '</div>' +
                    '</div>' +
                    '<div class="reclamo-detalle-item">' +
                    '<label><i class="bx bx-detail"></i> Descripción</label>' +
                    '<div class="value">' + (reclamo.descripcion || 'Sin descripción') + '</div>' +
                    '</div>' +
                    '<div class="reclamo-detalle-item">' +
                    '<label><i class="bx bx-info-circle"></i> Estado</label>' +
                    '<div class="value"><span class="reclamo-status status-' + (reclamo.estado || 'pendiente').toLowerCase() + '">' + 
                    (reclamo.estado ? reclamo.estado.charAt(0).toUpperCase() + reclamo.estado.slice(1) : 'Pendiente') + 
                    '</span></div>' +
                    '</div>' +
                    '<div class="reclamo-detalle-item">' +
                    '<label><i class="bx bx-flag"></i> Prioridad</label>' +
                    '<div class="value"><span class="reclamo-prioridad priority-' + (reclamo.prioridad || 'normal').toLowerCase() + '">' + 
                    (reclamo.prioridad ? reclamo.prioridad.charAt(0).toUpperCase() + reclamo.prioridad.slice(1) : 'Normal') + 
                    '</span></div>' +
                    '</div>';

          if (reclamo.fechaReclamo) {
            var fecha = new Date(reclamo.fechaReclamo);
            var fechaFormateada = fecha.toLocaleDateString('es-ES', { 
              year: 'numeric', 
              month: '2-digit', 
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            });
            html += '<div class="reclamo-detalle-item">' +
                   '<label><i class="bx bx-calendar"></i> Fecha del Reclamo</label>' +
                   '<div class="value">' + fechaFormateada + '</div>' +
                   '</div>';
          }

          if (reclamo.respuesta) {
            html += '<div class="reclamo-detalle-item">' +
                   '<label><i class="bx bx-message"></i> Respuesta</label>' +
                   '<div class="value" style="background: #e8f5e9; border-left: 4px solid #28a745; padding: 15px;">' + reclamo.respuesta + '</div>' +
                   '</div>';
          }

          if (reclamo.evaluacionCliente) {
            var evaluacionTexto = reclamo.evaluacionCliente === 'resuelta' ? 
              'El cliente indica que el reclamo fue resuelto' : 
              'El cliente indica que el reclamo no fue resuelto';
            var evaluacionColor = reclamo.evaluacionCliente === 'resuelta' ? '#28a745' : '#dc3545';
            var evaluacionIcono = reclamo.evaluacionCliente === 'resuelta' ? 'bx-check-circle' : 'bx-x-circle';
            
            html += '<div class="reclamo-detalle-item">' +
                   '<label><i class="bx bx-user-check"></i> Evaluación del Cliente</label>' +
                   '<div class="value" style="display: flex; align-items: center; gap: 8px; color: ' + evaluacionColor + ';">' +
                   '<i class="bx ' + evaluacionIcono + '" style="font-size: 1.2rem;"></i>' +
                   '<span style="font-weight: 600;">' + evaluacionTexto + '</span>' +
                   '</div>' +
                   '</div>';
          }

          document.getElementById('reclamoModalBody').innerHTML = html;
          document.getElementById('modalReclamo').classList.add('active');
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error al cargar el detalle del reclamo: ' + error.message);
        });
    }

    function cerrarModalReclamo() {
      document.getElementById('modalReclamo').classList.remove('active');
    }
  </script>
</body>
</html>

